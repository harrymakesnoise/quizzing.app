var timerRunning=!1,roundSettings={},scoreOverride={},questionTimerCountdown=null,questionTimerCountdownVal=0,changeCount=0,afterTimerAction=1,depthQuestionAnswers={},currentInspectedRoundId=0,currentInspectedQuestionId=0,currentInspectedLoaded=!1,questionTimerVal=0,answeredDataFromServer={},renderedAnswers={},teamsAnsweredData={};function game_control_sendtosite(){sendToServer()}
function game_control_clearpackets(){quizPackets=[];$("#sendtosite-control").find("tr").each(function(){$(this).attr("id")&&($(this).find("td").html("-"),$(this).fadeOut())});$("#sendtosite-control").slideUp()}function mc_gametoggle_start(){return{type:"game-event",command:"start-game"}}
function mc_gametoggle_start_cb(a){if(null!=a.currentdata&&null!=a.currentdata.rounds){var b="",c;for(c in a.currentdata.rounds){var d=a.currentdata.rounds[c];"questions"in d||(b+="<option value='"+d.roundid+"' data-label='"+encodeURI(d.label)+"'>"+d.label+"</option>")}$("#mc-roundlist").html(b).trigger("change");$("#mc-questionlist").html("").trigger("change")}}
function parseGameTimeline(a){for(var b="",c="",d=0;d<a.rounds.length;d++){var e=a.rounds[d];c+="<optgroup label='"+e.label+"'>";b+="<h4>"+e.label+"</h4><ol>";for(var f=0;f<e.questions.length;f++){var g=e.questions[f];b+="<li class='text-black-50' id='mc-quiztimeline-"+e.roundid+"-"+g.questionid+"'>"+g.label+"</li>";c+="<option value='"+e.roundid+"-"+g.questionid+"'>"+g.label+"</option>"}b+="</ol>";c+="</optgroup>";roundData[e.roundid]=e}$("#mc-questioninfo-selector").html(c).select2({theme:"bootstrap4"});
$("#mc-quiztimeline").html(b)}function mc_gametoggle_stop(){return{type:"game-event",command:"end-game"}}function mc_gametoggle_stop_cb(){}function mc_roundtoggle_start(){return{type:"game-event",command:"start-round",data:$("#"+$("#mc-roundtoggle-start").data("extradata")).val()}}function mc_roundtoggle_stop(){return{type:"game-event",command:"end-round"}}function mc_roundtoggle_stop_cb(){$("#mc-questionlist").html("");currentQuestion=null}
function mc_roundtoggle_start_cb(a){timerRunning=!1;var b="",c=roundData[parseInt(currentRound.roundid)];if(null!=c){if(null!=c.questions){b+="<optgroup label='"+c.label+"'>";for(var d in c.questions){var e=c.questions[d];b+="<option value='"+e.questionid+"' data-label='"+encodeURI(e.label)+"'>"+e.questionIndex+". "+e.label+"</option>"}}$("#mc-roundlist option").removeAttr("selected");$("#mc-roundlist option[value='"+c.roundid+"']").attr("selected","selected");$("#mc-questionlist").html(b).trigger("change");
roundSettings=a.currentdata.scoring;null!=a.currentdata.overridescoring&&(scoreOverride=a.currentdata.overridescoring);updateSeenQuestions();toggleRoundSettings()}}
function addScoreRow(){var a=$("#round-mod-score-dynamicrows").children().length+1,b="th";switch(a.toString().slice(-1)){case "1":b="st";break;case "2":b="nd";break;case "3":b="rd"}var c=a+"<sup>"+b+"</sup>",d=$("#round-mod-auto-scorer").prop("checked")?"":" disabled";b=null!=roundSettings[currentRound.roundid]?null!=roundSettings[currentRound.roundid]["round-mod-speed-score-"+a]?roundSettings[currentRound.roundid]["round-mod-speed-score-"+a]:0:0;c='<tr><td class="align-middle"><label for="round-mod-speed-score-'+
a+'" style="font-weight:normal;">'+c+' team to answer correctly</label></td><td class="align-middle"><div class="input-group"><input class="form-control" type="number" id="round-mod-speed-score-'+a+'" min="0" step="1"'+d+'><div class="input-group-append"><span class="input-group-text">pts</span></div></div></td></tr>';$("#round-mod-score-dynamicrows").append(c);$("#round-mod-score-remove").fadeIn();attachInputListeners();$("#round-mod-speed-score-"+a).val(b)}
function removeScoreRow(){var a=$("#round-mod-score-dynamicrows");a.children().last()[0].remove();0>=a.children().length&&$("#round-mod-score-remove").fadeOut();$("#mc-scoreoverride-send").show()}function getCompareRoundScores(){var a=roundSettings[currentRound.roundid];if(null!=a){for(var b=["round-mod-always-available","round-mod-end-after","round-mod-endroundafter-value"],c=0;c<b.length;c++){var d=b[c];0<=Object.keys(a).indexOf(d)&&delete a[d]}return a}return{}}var changedScoresFromDefault=!1;
function toggleRoundSettings(){$("#round-mod-score-dynamicrows").html("");var a={};a=null!=roundSettings[currentRound.roundid]?roundSettings[currentRound.roundid]:roundSettings["default"];var b=getCompareRoundScores();null!=scoreOverride&&0<Object.keys(scoreOverride).length&&JSON.stringify(scoreOverride)!=JSON.stringify(b)?(changedScoresFromDefault=!0,a=scoreOverride,$("#mc-scoreoverride-reset").show()):(changedScoresFromDefault=!1,$("#mc-scoreoverride-reset").hide());for(var c in a)"round-mod-speed-score-"==
c.substring(0,22)&&(b=c.substring(22,23),isNaN(b)||addScoreRow());var d=$("#roundModifierContainer input,#roundModifierContainer select,#roundModifierContainer button");d.each(function(){if(!$(this).hasClass("btn")&&null!=a){var e=null;null!=a[$(this).attr("id")]&&(e=a[$(this).attr("id")]);null!=e&&("checkbox"==$(this).attr("type")?($(this).prop("disabled",!1).change(),$(this).prop("checked",e).change()):$(this).hasClass("select2bs4")?$(this).val(e).trigger("change"):$(this).val(e))}});d.each(function(){"checkbox"!=
$(this).attr("type")&&$(this).prop("disabled",!$("#round-mod-auto-scorer").prop("checked"))});setTimeout(function(){d.each(function(){$(this).trigger("change")})},100)}function mc_questiontoggle_send(){return{type:"game-event",command:"send-question",data:{round:$("#"+$("#mc-roundtoggle-start").data("extradata")).val(),question:$("#"+$("#mc-questiontoggle-send").data("extradata")).val()}}}function mc_questiontoggle_clear(){return{type:"game-event",command:"end-question"}}
function calcScoreOverrideAllowed(){var a=$("#round-mod-auto-scorer").prop("checked");null!=currentRound&&null==currentQuestion?($("#round-mod-speedscore-buttons button,#roundModifierContainer input,#roundModifierContainer select").prop("disabled",!a),$("#round-mod-auto-scorer").prop("disabled",!1),$("#mc-score-config-alert").fadeOut()):($("#round-mod-speedscore-buttons button,#roundModifierContainer input,#roundModifierContainer select").prop("disabled",!0),$("#round-mod-auto-scorer").prop("disabled",
!0),$("#mc-score-config-alert").fadeIn())}function mc_scoreoverride_send(){var a={type:"game-event",command:"update-score-template",data:{}};$("#roundModifierContainer input,#roundModifierContainer select").each(function(){var b=$(this).val();"checkbox"==$(this).attr("type")&&(b=$(this).prop("checked"));a.data[$(this).attr("id")]=b});return a}function mc_scoreoverride_send_cb(a){scoreOverride=a.currentdata.overridescoring;$("#mc-scoreoverride-send").hide();toggleRoundSettings()}
function mc_scoreoverride_reset_cb(a){scoreOverride={};toggleRoundSettings()}function mc_scoreoverride_reset(){if(changedScoresFromDefault)return{type:"game-event",command:"update-score-template",data:roundSettings[currentRound.roundid]};scoreOverride={};toggleRoundSettings()}function mc_questiontoggle_clear_cb(){}function showRoundAlert(){}
function mc_questiontoggle_send_cb(){timerRunning=!1;if(null==currentRound)return!1;$("#mc-questionlist option").removeAttr("selected");$("#mc-quiztimeline li").removeClass("text-bold");$("#mc-quiztimeline-"+currentRound.roundid+"-"+currentQuestion.questionid).addClass("text-bold");0!=currentInspectedRoundId&&currentInspectedRoundId!=currentRound.roundid||0!=currentInspectedQuestionId&&currentInspectedQuestionId!=currentQuestion.questionid||(renderQuestionInformation(currentRound.roundid,currentQuestion.questionid),
$("#mc-questioninfo-selector option").removeAttr("selected"),$("#mc-questioninfo-selector option[value='"+currentRound.roundid+"-"+currentQuestion.questionid+"']").attr("selected","selected").trigger("change"),renderedAnswers={});$("#mc-questionlist option[value="+currentQuestion.questionid+"]").attr("selected","selected").parent().val(currentQuestion.questionid).trigger("change");$("#mc-teamsanswered .status span").html("Waiting").removeClass("badge-success").removeClass("badge-warning").addClass("badge-secondary")}
function renderQuestionInformation(a,b){if(null!=roundData[a]){for(var c=roundData[a].questions,d="",e=0;e<c.length;e++)c[e].questionid==b&&(qdata=c[e],d="<h4>"+qdata.label+"</h4>",null!=qdata.correctanswers&&(d="array"===typeof qdata.correctanswers?d+("<p>Correct answer(s): <strong>"+qdata.correctanswers.join(",")+"</strong>"):d+("<p>Correct answer(s): <strong>"+qdata.correctanswers+"</strong>")));$("#mc-questioninfo").html(d);questionAnswersTable.clear().draw();quizServer.server.send(JSON.stringify({type:"game-event",
command:"get-answers",callback:"mc_getanswers_cb",data:{roundid:a,questionid:b}}))}}function mc_getanswers_cb(a){mc_teamanswered_cb(a.gameupdate)}
function mc_teamanswered_cb(a){null!=a.gameupdate&&(a=a.gameupdate);null!=a.teamsanswered&&(a=a.teamsanswered);for(var b in a)for(var c in a[b])for(var d in a[b][c]){var e={};null!=seenGameData.allusers&&null!=seenGameData.allusers[b]&&(e=seenGameData.allusers[b]);e={user:e,data:a[b][c][d]};var f=c+"-"+d;null!=teamsAnsweredData&&(null==teamsAnsweredData[f]&&(teamsAnsweredData[f]={}),null!=teamsAnsweredData[f][b]&&JSON.stringify(e)!=JSON.stringify(teamsAnsweredData[f][b])&&(questionAnswersTable.rows(function(g,
h,k){return parseInt(h[0])===parseInt(b)}).remove().draw(!1),delete renderedAnswers[b]),teamsAnsweredData[f][b]=e)}refreshQuestionInfoAnswers();makeAnsweredCounts()}
function refreshQuestionInfoAnswers(){var a=currentInspectedRoundId,b=currentInspectedQuestionId;0==a&&0==b&&null!=currentRound&&null!=currentQuestion&&(a=currentRound.roundid,b=currentQuestion.questionid);if(null!=teamsAnsweredData){var c=a+"-"+b;if(null!=teamsAnsweredData[c])for(var d in teamsAnsweredData[c]){var e=teamsAnsweredData[c][d];if(null==renderedAnswers[d]){var f=e.data,g=e.user;if(null!=f.awardedscore||null!=f.amendedscore){var h=0;null!=f.awardedscore&&0!=f.awardedscore&&(h=f.awardedscore);
null!=f.amendedscore&&0!=f.amendedscore&&(h=f.amendedscore);var k="",l='<input type="number" step="1" value="'+h+'" id="mc-adjustanswer-'+g.userid+"-"+a+"-"+b+'"><button class="btn btn-md btn-success" onClick="mc_adjustanswer('+g.userid+", "+a+", "+b+", $('#mc-adjustanswer-"+g.userid+"-"+a+"-"+b+"').val());$(this).remove();return false;\">Adjust Score</button>";null!=f.incorrectanswers&&0<f.incorrectanswers.length&&(k=f.incorrectanswers.join(","));null!=f.correctanswers&&0<f.correctanswers.length&&
(k=f.correctanswers.join(","));questionAnswersTable.row.add([g.userid,g.username,k,h,l]).draw(!1)}renderedAnswers[d]=e}}}}
function makeAnsweredCounts(){if(null!=seenGameData.connectedusers){var a=Object.keys(seenGameData.connectedusers).length,b=0;if(null!=currentRound&&null!=currentQuestion){var c=currentRound.roundid+"-"+currentQuestion.questionid;if(null!=teamsAnsweredData[c]){b=Object.keys(teamsAnsweredData[c]).length;for(var d in teamsAnsweredData[c]){var e="badge-warning";null!=teamsAnsweredData[c][d].data.correctanswers&&0<teamsAnsweredData[c][d].data.correctanswers.length&&(e="badge-success");$("#mc-teamsanswered-"+
d+"-status").html("Answered").removeClass("badge-secondary").removeClass("badge-success").removeClass("badge-warning").addClass(e)}}}c=a-b;$("#mc-teamsanswered-count").html(a<=b?a:b);$("#mc-teamsanswered-teamtotal").html(a);$("#mc-teamsanswered-remain").html(0>c?0:c)}}function mc_adjustanswer(a,b,c,d){sendToServer({type:"game-event",command:"update-answer-score",data:{roundid:b,questionid:c,score:d},user:{userid:a}})}
function mc_questiontimer_send(){questionTimerVal=parseInt($("#mc-questiontimer").val());if(0<questionTimerVal)return{type:"game-event",command:"timer",data:{time:questionTimerVal,action:afterTimerAction}}}
function initialiseTimer(a){clearTimeout(questionTimerCountdown);0<=questionTimerCountdownVal&&$("#mc-questiontimer").val(questionTimerCountdownVal);if(0<=questionTimerCountdownVal){--questionTimerCountdownVal;if(!timerRunning)return!1;questionTimerCountdown=setTimeout(initialiseTimer,1E3)}else clearTimeout(questionTimerCountdown),$("#mc-questiontimer").val(questionTimerVal)}
function mc_questiontimer_send_cb(a){null!=a.currentdata.timerrunning?(timerRunning=!0,questionTimerCountdownVal=parseInt(a.currentdata.timerrunning)-1,questionTimerCountdown=setTimeout(initialiseTimer,1E3)):(timerRunning=!1,seenGameData.timerrunning=null,resetControlButtons(seenGameData))}function mc_questiontimer_cancel_cb(){timerRunning=!1}
function resetControlButtons(a){null==a.currentdata&&(a.currentdata=a);$("[data-disable]").each(function(){var b=JSON.parse($(this).attr("data-disable")),c=!1,d;for(d in b)null!=a.currentdata[d]?1==b[d]&&(c=!0):0==b[d]&&(c=!0);$(this).prop("disabled",c)})}
function checkInputChanges(){var a={};$("#roundModifierContainer input").each(function(){var b=$(this).val();"checkbox"==$(this).attr("type")&&(b=$(this).prop("checked"));a[$(this).attr("id")]=b});0<Object.keys(scoreOverride).length&&JSON.stringify(a)!=JSON.stringify(scoreOverride)||0==Object.keys(scoreOverride).length&&JSON.stringify(a)!=JSON.stringify(getCompareRoundScores())?($("#mc-scoreoverride-send").show(),$("#mc-scoreoverride-reset").show()):($("#mc-scoreoverride-send").hide(),0<Object.keys(scoreOverride).length?
$("#mc-scoreoverride-reset").show():$("#mc-scoreoverride-reset").hide())}function attachInputListeners(){$("#roundModifierContainer input").on("change keyup",function(){changeCount++;if(changeCount<=$("#roundModifierContainer input").length+1)return!1;setTimeout(checkInputChanges,100)})}
function changeQuestionTimer(a){"undefiend"===typeof a&&(a=null);null!=a&&($(".input-group-append li").removeClass("active"),$(".input-group-append li a").removeClass("text-white"),$("#mc-questiontimer-opt"+a).addClass("active"),$("#mc-questiontimer-opt"+a+" a").addClass("text-white"),afterTimerAction=a);a=$(".input-group-append li.active a");var b=$("#mc-questiontimer").val();b+=" seconds. After countdown finishes: ";b=a.length?b+a.html():b+"Clear Current Question";b+=".";$("#mc-questiontimer-summary").val(b)}
function updateSeenQuestions(){var a=!1,b=!1,c;for(c in seenQuestions){var d=c.split("-"),e=parseInt(d[0]);d=parseInt(d[1]);var f=$("#mc-roundlist option[value='"+e+"']");f.length&&"&gt;"!=f.html().substr(0,4)&&(f.html("&gt; "+f.html()),a=!0);null!=currentRound&&e==currentRound.roundid&&(f=$("#mc-questionlist option[value='"+d+"']"),f.length&&"&gt;"!=f.html().substr(0,4)&&(f.html("&gt; "+f.html()),b=!0));f=$("#mc-quiztimeline-"+c);f.length&&(f.hasClass("text-cyan")||f.addClass("text-cyan"))}a&&$("#mc-roundlist").select2("destroy").select2({theme:"bootstrap4"});
b&&$("#mc-questionlist").select2("destroy").select2({theme:"bootstrap4"})}
$(document).ready(function(){$("#mc-questiontimer").on("change keyup",function(){changeQuestionTimer()});$("#round-mod-auto-scorer").on("change",function(){$(this).prop("checked")?$('#roundModifierContainer input[type!="checkbox"],#roundModifierContainer select,#roundModifierContainer button').prop("disabled",!1):$('#roundModifierContainer input[type!="checkbox"],#roundModifierContainer select,#roundModifierContainer button').prop("disabled",!0)});$("#mc-questioninfo-selector").on("change",function(){var a=
$(this).val().toString().split("-");currentInspectedLoaded?(currentInspectedRoundId=parseInt(a[0]),currentInspectedQuestionId=parseInt(a[1]),null!=currentRound&&null!=currentQuestion&&currentRound.roundid==currentInspectedRoundId&&currentInspectedQuestionId==currentQuestion.questionid&&(currentInspectedQuestionId=currentInspectedRoundId=0)):currentInspectedLoaded=!0;renderedAnswers={};renderQuestionInformation(a[0],a[1])});$("button").click(function(a){if(""!=$(this).attr("id")){a.preventDefault();
if("true"==$(this).prop("disabled"))return!1;var b=$("#"+$(this).data("controls")),c=$(this).data("label");a=$("#"+$(this).data("extradata")+" option:selected");a.length?c+=": "+decodeURI(a.data("label")):(a=$("#"+$(this).data("extradata")),a.length&&(c+=": "+a.val()));a=$(this).attr("id");if("undefined"!==typeof a){a=a.toString();a=a.replace(/-/g,"_");var d=window[a],e;"function"===typeof d&&(e=d());null!=e&&("function"===typeof window[a+"_cb"]&&(e.callback=a+"_cb"),$("#mc-auto-confirm-commands").prop("checked")?
sendToServer(e):b.length&&($("#sendtosite-control").slideDown().promise().done(function(){$(b).find("td").html(c);$(b).fadeIn()}),quizPackets.push(e)))}}});attachInputListeners();toggleRoundSettings()});