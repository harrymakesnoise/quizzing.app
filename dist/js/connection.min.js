var quizServer={},quizPackets=[],awaitResponse=[],initialLoaded=!1,currentQuestion={},currentRound={},allScores={},lastLeaderboard={},allScoresArray=[],roundData={},lastConnectedUsers={},seenGameData={},seenQuestions={},answeredQuestions={},userScoreUpdates=[],shouldReconnect=!0,sfxQuestion=new Audio("/siteassets/question-change.mp3"),hasAuthed=!1,leaderboardUpdating=!1,reconnectTimer,pingPong;sfxQuestion.autoplay=!1;sfxQuestion.muted=!0;sfxQuestion.loop=!1;sfxQuestion.volume=.6;
function getFullGameData(a){if(null!=a.currentdata){var b=seenGameData,c;for(c in a.currentdata)b[c]=a.currentdata[c];a.currentdata=b}if(null!=a.gameupdate)for(c in a.gameupdate)a.currentdata[c]=a.gameupdate[c];return a}function ping_cb(a){a=new Date(a.date);a=(new Date).getTime()-a.getTime();$("#mc-ping-out").html("<b>Ping</b> "+a+"ms. | ")}
function ping(a){"undefined"===typeof a&&(a=2E4);clearInterval(pingPong);pingPong=setInterval(function(){sendToServer({type:"ping",date:(new Date).toISOString()});ping()},a)}
function connectToServer(){toastr.info("Connecting to Game");quizServer.server=new WebSocket("wss://"+window.location.hostname+"/websocket");quizServer.server.onopen=function(a){quizServer.server.send(JSON.stringify({userAuth:userAuth,gameid:gameid}));toastr.info("Authenticating with Game")};quizServer.server.onmessage=function(a){a=JSON.parse(a.data);if(null!=a.request)for(var b=awaitResponse.length-1;0<=b;b--)awaitResponse[b].toString()==a.request.toString()&&awaitResponse.splice(b,1);updateServerStatus();
if(null!=a.type){if("ping"==a.type)return ping_cb(a),!1;if("user-change"==a.type)return null!=a.user.username&&$("[data-teamid='"+a.user.userid+"'] [data-fieldname='username']").html(a.user.username),null!=a.user.avatarurl&&$("[data-teamid='"+a.user.userid+"'] [data-fieldname='avatar']").attr("src","/siteassets/user-images/"+a.user.avatarurl),!1}null!=a.currentdata&&(seenGameData=a.currentdata,hasAuthed||(hasAuthed=!0,toastr.success("Logged into Game, enjoy!"),0<quizPackets.length&&sendToServer(),
ping(1)));null!=a.gameupdate&&(a.currentdata=a.gameupdate);null!=a.gametimeline&&parseGameTimeline(a.gametimeline);null!=a.answeredquestions&&(answeredQuestions=a.answeredquestions);if(null!=a.currentdata){null!=a.currentdata.ended&&mc_gametoggle_stop_cb();null!=a.currentdata.started&&(b=getFullGameData(a),mc_gametoggle_start_cb(b),null!=b.currentdata.started?"none"!=$("#mc-player-waiting").css("display")?$("#mc-player-waiting").slideUp().promise().done(function(){$("#mc-player-gamearea").slideDown()}):
$("#mc-player-gamearea").slideDown():($("#mc-player-gamearea").hide(),$("#mc-player-waiting").slideDown()));if(null!=a.currentdata.chatbox&&"function"===typeof window.receiveMessage)for(b=0;b<a.currentdata.chatbox.length;b++)receiveMessage(a.currentdata.chatbox[b]);"round"in a.currentdata&&(currentRound=a.currentdata.round);"question"in a.currentdata&&(currentQuestion=a.currentdata.question);"round"in a.currentdata&&(b=getFullGameData(a),null!=a.currentdata.round?(mc_roundtoggle_start_cb(b),showRoundAlert("round",
b.currentdata.round.roundid)):mc_roundtoggle_stop_cb());"question"in a.currentdata&&null!=currentRound&&(null!=a.currentdata.question?(mc_questiontoggle_send_cb(a),b=getFullGameData(a),showRoundAlert("question",b.currentdata.round.roundid),setTimeout(function(){},10)):mc_questiontoggle_clear_cb(a));if("allusers"in a.currentdata)for(var c in a.currentdata.allusers)null!=a.currentdata.leaderboard&&null!=a.currentdata.leaderboard[a.currentdata.allusers[c].userid]&&(a.currentdata.allusers[c].score=a.currentdata.leaderboard[a.currentdata.allusers[c].userid]),
null!=a.currentdata.allusers[c].player&&a.currentdata.allusers[c].player&&addPlayerToGame(a.currentdata.allusers[c]),addPlayerToChat(a.currentdata.allusers[c]);"connectedusers"in a.currentdata&&applyPlayerScores();"seenquestions"in a.currentdata&&"function"===typeof window.updateSeenQuestions&&(seenQuestions=a.currentdata.seenquestions,updateSeenQuestions());"teamsanswered"in a.currentdata&&"function"===typeof window.mc_teamanswered_cb&&mc_teamanswered_cb(a.currentdata);"timerrunning"in a.currentdata&&
"function"===typeof window.start_countdown&&(0<parseInt(a.currentdata.timerrunning)?start_countdown(parseInt(a.currentdata.timerrunning)):($("#countdown").fadeOut(),clearInterval(countdownInterval)));"userscore"in a.currentdata&&(null!=seenGameData.leaderboard&&(seenGameData.leaderboard[a.currentdata.userscore.userid]=a.currentdata.userscore.score),applyPlayerScores());"leaderboard"in a.currentdata&&applyPlayerScores();null!=a.request&&null!=a.request.callback&&(c=window[a.request.callback],"function"===
typeof c&&c(a));"function"===typeof window.resetControlButtons&&(b=getFullGameData(a),resetControlButtons(b),$("#mainControlWrapper .overlay").fadeOut());"function"===typeof window.calcScoreOverrideAllowed&&calcScoreOverrideAllowed()}null!=a.type&&("chat-message"==a.type&&"function"===typeof window.receiveMessage&&receiveMessage(a),"chat-remove"==a.type&&"function"===typeof window.removeMessage&&removeMessage(a),"answer-submit"==a.type&&submitanswer_cb(a),"error"==a.type&&(toastr.error(a.message),
a.disconnect&&(shouldReconnect=!1,showErrorOverlay(a.message),quizServer.server.close()),"chat-message"==a.request.type&&(isSendingMessage=!1)),"remove-player"==a.type&&removePlayerFromGame(a.userid))};quizServer.server.onclose=function(a){clearInterval(pingPong);hasAuthed=!1;a.wasClean?console.log("[close] Connection closed cleanly, code=${event.code} reason=${event.reason}"):(shouldReconnect?(clearTimeout(reconnectTimer),toastr.error("You're offline. Retrying to connect in 3 seconds."),reconnectTimer=
setTimeout(function(){connectToServer();sendToServer()},3E3)):toastr.error("You have been disconnected."),console.log("[close] lost connetion?"))};quizServer.server.onerror=function(a){}}
function sendToServer(a){"undefined"===typeof a&&(a={});if(hasAuthed)if(quizServer.server.readyState==WebSocket.OPEN)if(0<Object.keys(a).length)quizServer.server.send(JSON.stringify(a)),awaitResponse.push(a),null!=a.type&&"ping"!=a.type&&$(".sendtosite-control-overlay").html('<i class="fas fa-2x fa-sync fa-spin"></i>').fadeIn();else{for(a=0;a<quizPackets.length;a++)awaitResponse.push(quizPackets[a]),quizServer.server.send(JSON.stringify(quizPackets[a])),quizPackets.splice(a,1);$(".sendtosite-control-overlay").html('<i class="fas fa-2x fa-sync fa-spin"></i>').fadeIn()}else 0<
Object.keys(a).length&&quizPackets.push(a),quizServer.server.close(),connectToServer()}function updateServerStatus(){0==awaitResponse.length?syncFinished():console.log("Awaiting "+awaitResponse.length+" packets")}
function syncFinished(a){"undefined"===typeof a&&(a=1);a*=1E3;quizPackets=[];$(".sendtosite-control-overlay").html('<i class="fas fa-2x fa-check"></i>');$("#admin-chat-modal").modal("hide");setTimeout(function(){$("#sendtosite-control").find("tr").each(function(){$(this).attr("id")&&($(this).find("td").html("-"),$(this).fadeOut())});$(".sendtosite-control-overlay").fadeOut();$("#sendtosite-control").slideUp()},a)}
function showErrorOverlay(a){$("body").append('<div class="modal fade" id="modal-error" data-backdrop="static" data-keyboard="false"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h4 class="modal-title">Game Disconnected</h4></div><div class="modal-body"><p>'+a+'</p></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-primary" onClick=\'window.location="//'+window.location.hostname+'";window.location.href="//'+window.location.hostname+
"\";'>Go Home</button></div></div>\x3c!-- /.modal-content --\x3e</div>\x3c!-- /.modal-dialog --\x3e</div>\x3c!-- /.modal --\x3e");$("#modal-error").modal("show")}function isJson(a){a="string"!==typeof a?JSON.stringify(a):a;try{a=JSON.parse(a)}catch(b){return!1}return"object"===typeof a&&null!==a?!0:!1};